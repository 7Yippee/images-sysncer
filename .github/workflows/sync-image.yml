name: Sync-Images-to-DockerHub
run-name: ${{ github.actor }} is Syncing Images to Aliyun.

on:
  push:
    branches: [ "main" ]
    paths:
      - 'image-list.txt'
      - '.github/workflows/sync-images.yml'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  syncimages:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repos
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2.9.1

    - name: Install Skopeo
      run: |
        sudo apt-get update
        sudo apt-get install -y skopeo

    - name: Login to Aliyun Registry
      uses: docker/login-action@v2.2.0
      with:
        registry: registry.cn-guangzhou.aliyuncs.com
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        logout: false
        
    - name: Sync Images to Aliyun Registry
      run: |
        #!/usr/bin/env bash
        set -e
        
        # --- é…ç½®åŒºåŸŸ ---
        # é˜¿é‡Œäº‘ä»“åº“åœ°å€
        ALI_REGISTRY="registry.cn-guangzhou.aliyuncs.com"
        # ä½ çš„å‘½åç©ºé—´ (æ¯”å¦‚ tools_y)
        ALI_NAMESPACE="tools_y"
        # æœ€å¤§å¹¶å‘æ•° (å»ºè®® 3-5ï¼Œå¤ªé«˜å®¹æ˜“è¢«å° IP)
        MAX_PARALLEL=8
        # ----------------
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p logs
        touch logs/success.log logs/failed.log
        
        # --- æ ¸å¿ƒå‡½æ•°: æ‰å¹³åŒ–å‘½åé˜²æ­¢å†²çª ---
        # é€»è¾‘: ç§»é™¤ docker.io å‰ç¼€ï¼Œç„¶åå°†è·¯å¾„ä¸­çš„ / æ›¿æ¢ä¸º _
        # ä¾‹1: docker.io/bitnami/mysql:8.0 -> bitnami_mysql:8.0
        # ä¾‹2: registry.k8s.io/sig-storage/snapshot-controller:v1 -> sig-storage_snapshot-controller:v1
        get_flat_name() {
            local img=$1
            # 1. å…ˆå»æ‰ docker.io/library/ (å®˜æ–¹é•œåƒç‰¹ä¾‹ï¼Œç›´æ¥å˜çŸ­)
            local temp=${img#docker.io/library/}
            # 2. å»æ‰ docker.io/ (æ™®é€š Docker Hub é•œåƒ)
            temp=${temp#docker.io/}
            # 3. å»æ‰ registry.k8s.io/ ç­‰åŸŸåå‰ç¼€ (å¯é€‰ï¼Œè¿™é‡Œæˆ‘ä¿ç•™äº†åŸŸååçš„è·¯å¾„)
            # å¦‚æœæƒ³å»æ‰åŸŸåä¿ç•™è·¯å¾„ï¼Œå¯ä»¥æŠŠä¸‹é¢è¿™è¡Œè§£å¼€ï¼Œä½†ä¸ºäº†åŒºåˆ†æºï¼Œå»ºè®®ä¸å»æ‰åŸŸåï¼Œæˆ–è€…åªå»æ‰å¸¸è§åŸŸå
            # è¿™é‡Œæˆ‘ä»¬åªå¤„ç† docker.ioï¼Œå…¶ä»–æºä¿ç•™åŸŸåå¤ªé•¿äº†ï¼Œæˆ‘ä»¬ç”¨é€šç”¨é€»è¾‘ï¼š
            # ç®€å•çš„ç­–ç•¥ï¼šç›´æ¥æŠŠå®Œæ•´å­—ç¬¦ä¸²é‡Œçš„ / å…¨éƒ¨æ¢æˆ _ï¼Œä½†å»æ‰ docker.io/library/ è¿™ç§åºŸè¯
            
            # æœ€ç»ˆç­–ç•¥ï¼šç§»é™¤å¸¸è§å‰ç¼€åï¼Œå‰©ä½™éƒ¨åˆ† / å˜ _
            temp=$(echo "$img" | sed -e 's|^docker.io/library/||' -e 's|^docker.io/||' -e 's|^registry.k8s.io/||' -e 's|^k8s.gcr.io/||' -e 's|^gcr.io/||' -e 's|^quay.io/||')
            
            # å°†å‰©ä½™è·¯å¾„ä¸­çš„æ–œæ æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
            echo "$temp" | tr '/' '_ '
        }

        echo "ğŸš€ Starting image sync process to ${ALI_REGISTRY}/${ALI_NAMESPACE}..."
        
        # è¯»å–é•œåƒåˆ—è¡¨
        while IFS= read -r image || [ -n "$image" ]; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
          [[ -z "$image" || "$image" =~ ^#.*$ ]] && continue
          
          # 1. å¹¶å‘æ§åˆ¶: ç­‰å¾…åå°ä»»åŠ¡å°‘äº MAX_PARALLEL
          while [ $(jobs -r | wc -l) -ge $MAX_PARALLEL ]; do
            sleep 1
          done
          
          # 2. è®¡ç®—ç›®æ ‡é•œåƒå
          flat_name=$(get_flat_name "$image")
          target_image="${ALI_REGISTRY}/${ALI_NAMESPACE}/${flat_name}"
          
          echo "Processing: $image -> $target_image"
          
          # 3. åå°æ‰§è¡ŒåŒæ­¥ (Skopeo)
          (
            # ä½¿ç”¨ skopeo copy æ¬è¿ï¼Œå¤±è´¥åˆ™è®°å½•æ—¥å¿—
            if skopeo copy --all --dest-creds "${{ secrets.DOCKER_USERNAME }}:${{ secrets.DOCKER_PASSWORD }}" "docker://$image" "docker://$target_image"; then
                echo "[SUCCESS] $image -> $target_image" >> logs/success.log
                echo "âœ… $image åŒæ­¥å®Œæˆ"
            else
                echo "[FAILED] $image -> $target_image" >> logs/failed.log
                echo "âŒ $image åŒæ­¥å¤±è´¥"
            fi
          ) &
        done < image-list.txt
        
        # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡ç»“æŸ
        wait
        
        # --- è¾“å‡ºç»Ÿè®¡ç»“æœ ---
        echo "========================================"
        echo "ğŸ“Š åŒæ­¥ç»“æœç»Ÿè®¡:"
        echo "âœ… æˆåŠŸ: $(wc -l < logs/success.log)"
        
        if [ -s logs/failed.log ]; then
          echo "âŒ å¤±è´¥: $(wc -l < logs/failed.log)"
          echo "ğŸ”´ å¤±è´¥åˆ—è¡¨:"
          cat logs/failed.log
          exit 1
        else
          echo "ğŸ‰ å…¨éƒ¨æˆåŠŸ!"
        fi
